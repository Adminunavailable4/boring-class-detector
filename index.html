<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Boring Class Detector</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        h1 { margin-bottom: 10px; }

        /* The Main Container */
        .container {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #2d2d2d;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Video Feed Wrapper */
        .video-wrapper {
            position: relative;
            width: 640px;
            height: 480px;
            background: black;
            border-radius: 10px;
            overflow: hidden;
        }

        video {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* Mirror effect */
        }

        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        /* The "Digital Hardware" Panel */
        .panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Digital LED Screen */
        .digital-screen {
            background-color: #4a5c4a; /* Dark LCD color */
            color: #00ff00; /* Classic LCD Green */
            font-family: 'Courier New', Courier, monospace;
            padding: 20px;
            border-radius: 5px;
            border: 4px solid #333;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.5rem;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
            transition: all 0.3s;
        }

        .digital-screen.alert {
            background-color: #5c1a1a;
            color: #ff0000;
            text-shadow: 0 0 10px red;
            animation: flash 0.5s infinite alternate;
        }

        @keyframes flash {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }

        /* Stats Area */
        .stats {
            background: #333;
            padding: 15px;
            border-radius: 8px;
        }

        .stat-item {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .highlight { font-weight: bold; color: #00aaff; }

        button {
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>

    <h1>ü•± Boring Class Detector</h1>

    <div class="container">
        <div class="video-wrapper">
            <video id="input_video"></video>
            <canvas id="output_canvas"></canvas>
        </div>

        <div class="panel">
            <div id="lcd-display" class="digital-screen">
                SYSTEM OFF<br>Press Start
            </div>

            <div class="stats">
                <div class="stat-item">Total Faces: <span id="face-count" class="highlight">0</span></div>
                <div class="stat-item">Bored Faces: <span id="bored-count" class="highlight">0</span></div>
                <div class="stat-item">Boredom Level: <span id="bored-percent" class="highlight">0%</span></div>
            </div>

            <button id="start-btn" onclick="startSystem()">Start Detection</button>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const MAR_THRESHOLD = 0.5; // Mouth open size (Yawn)
    const EAR_THRESHOLD = 0.25; // Eye closed size (Sleep)
    const BOREDOM_TRIGGER = 0.4; // 40% of class bored triggers alarm

    // --- ELEMENTS ---
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const lcdDisplay = document.getElementById('lcd-display');
    const faceCountEl = document.getElementById('face-count');
    const boredCountEl = document.getElementById('bored-count');
    const boredPercentEl = document.getElementById('bored-percent');
    const startBtn = document.getElementById('start-btn');

    let audioCtx = null;
    let oscillator = null;
    let isAlarming = false;

    // --- AUDIO SYSTEM (Virtual Buzzer) ---
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playBuzzer(active) {
        if (active && !isAlarming) {
            isAlarming = true;
            oscillator = audioCtx.createOscillator();
            oscillator.type = 'sawtooth'; // Harsh buzzer sound
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4 note
            
            // Modulation for "Police Siren" effect
            oscillator.frequency.linearRampToValueAtTime(880, audioCtx.currentTime + 0.5);
            
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); // Volume (0.1 to save ears)
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
        } else if (!active && isAlarming) {
            isAlarming = false;
            if (oscillator) {
                oscillator.stop();
                oscillator.disconnect();
            }
        }
    }

    // --- MATH HELPERS ---
    function distance(p1, p2) {
        return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    // --- MAIN LOGIC ---
    function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        let totalFaces = 0;
        let boredFaces = 0;

        if (results.multiFaceLandmarks) {
            totalFaces = results.multiFaceLandmarks.length;

            for (const landmarks of results.multiFaceLandmarks) {
                // MediaPipe coordinates are 0.0-1.0. We map them later if needed.
                
                // --- 1. MOUTH ASPECT RATIO (Yawn) ---
                // Upper Lip: 13, Lower: 14 | Corners: 61, 291
                const mouthH = distance(landmarks[61], landmarks[291]);
                const mouthV = distance(landmarks[13], landmarks[14]);
                const mar = mouthV / mouthH;

                // --- 2. EYE ASPECT RATIO (Sleep) ---
                // Left Eye Vertical: 159-145 | Horizontal: 33-133
                const eyeV = distance(landmarks[159], landmarks[145]);
                const eyeH = distance(landmarks[33], landmarks[133]);
                const ear = eyeV / eyeH;

                let isBored = false;
                
                // Logic Check
                if (mar > MAR_THRESHOLD || ear < EAR_THRESHOLD) {
                    isBored = true;
                    boredFaces++;
                }

                // --- DRAWING ---
                // Draw a box around the face (simple approx using forehead and chin)
                const x = landmarks[1].x * canvasElement.width;
                const y = landmarks[1].y * canvasElement.height;
                
                canvasCtx.fillStyle = isBored ? "red" : "#00ff00";
                canvasCtx.font = "20px Arial";
                canvasCtx.fillText(isBored ? "ü•± BORED" : "üòÉ ACTIVE", x, y);
            }
        }

        // --- UPDATE DASHBOARD ---
        faceCountEl.innerText = totalFaces;
        boredCountEl.innerText = boredFaces;
        
        let boredPercent = totalFaces > 0 ? (boredFaces / totalFaces) : 0;
        boredPercentEl.innerText = Math.round(boredPercent * 100) + "%";

        // --- TRIGGER ALARM ---
        if (totalFaces > 0 && boredPercent >= BOREDOM_TRIGGER) {
            lcdDisplay.innerHTML = "‚ö†Ô∏è CLASS IS<br>BORING!";
            lcdDisplay.classList.add("alert");
            playBuzzer(true);
        } else {
            lcdDisplay.innerHTML = "Class is<br>Engaging...";
            lcdDisplay.classList.remove("alert");
            playBuzzer(false);
        }

        canvasCtx.restore();
    }

    // --- SETUP MEDIAPIPE ---
    const faceMesh = new FaceMesh({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }});
    
    faceMesh.setOptions({
        maxNumFaces: 5,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    
    faceMesh.onResults(onResults);

    // --- START CAMERA ---
    function startSystem() {
        initAudio(); // Initialize audio context on user click
        startBtn.style.display = 'none'; // Hide button
        lcdDisplay.innerText = "Loading AI...";

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await faceMesh.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();
    }
</script>

</body>
</html>
